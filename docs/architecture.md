# Architecture

This document provides a comprehensive overview of Claudet's architecture, technology stack, and organizational structure.

## Technology Stack

- **Runtime:** [Bun](https://bun.sh) - All-in-one JavaScript runtime
- **Framework:** [React 19](https://react.dev/) - UI library
- **Styling:** [Tailwind CSS 4](https://tailwindcss.com/) - Utility-first CSS framework
- **Components:** [shadcn/ui](https://ui.shadcn.com/) - Re-usable components built with Radix UI
- **State Management:** [XState 5](https://stately.ai/docs/xstate) - State machines for both backend and frontend
- **AI Integration:** Claude Code CLI - Persistent session with streaming I/O
- **Testing:** Bun test runner (unit) + [Playwright](https://playwright.dev/) (E2E)
- **PWA:** Service Worker + Web App Manifest - Offline-first progressive web app

## Server Architecture

This is a **Bun-native full-stack application** using `Bun.serve()` with routing, WebSockets, and HTML imports.

### 1. HTML Import Pattern

Server imports `index.html` which includes `<script type="module" src="./frontend.tsx">`. Bun's bundler automatically transpiles and bundles React/TypeScript.

### 2. Persistent Claude CLI Integration (with Dependency Injection)

- Spawns a long-running `claude` CLI process with streaming JSON I/O
- **Abstraction Layer**: `ClaudeCodeService` interface allows swapping real vs. fake implementations
- **Production**: Uses `RealClaudeCodeService` (spawns actual Claude CLI)
- **Testing**: Uses `FakeClaudeCodeService` (mock with deterministic responses)
- Maintains session state and request/response correlation via session IDs
- API endpoint at `/api/chat` for sending messages to Claude
- WebSocket endpoint at `/ws` for real-time log streaming to clients

### 3. State Machine (src/backend/claudeRunner.ts)

- XState 5 state machine manages Claude process lifecycle
- Factory pattern: `createClaudeRunnerMachine(service)` accepts injected service
- Handles process startup, message sending, output parsing, and error recovery

### 4. HTTPS Development Server

- Uses self-signed TLS certificates in `./certs/` directory (generated via mkcert)
- Certificates are generated by running `bun run setup` or `bun run generate:certs`
- Server checks for certificate existence on startup and provides helpful error if missing
- Serves on `0.0.0.0:3000` for network access
- Displays QR code on startup for easy mobile access

### 5. Routes

- `/*` - Serves index.html (SPA fallback)
- `/api/chat` - POST endpoint for Claude interactions
- `/api/models` - GET endpoint for available models
- `/api/sessions` - GET/POST endpoints for session management
- `/ws` - WebSocket upgrade endpoint
- PWA assets: `/manifest.json`, `/sw.js`, icons

## Frontend Architecture

- **React 19** with TypeScript
- **Tailwind CSS 4** for styling (uses `bun-plugin-tailwind`)
- **shadcn/ui** components in `src/components/ui/`
- **PWA Support**: Service worker, manifest, and icon generation
- Path alias: `@/*` maps to `./src/*`

### Dark Mode Implementation

The application supports three theme modes: `light`, `dark`, and `system` (follows OS preference).

#### Architecture

1. **ThemeProvider** (`src/frontend/components/ThemeProvider.tsx`):
   - React Context-based theme management using `useState` and `useContext`
   - Persists preference to `localStorage` with key `claudet-ui-theme`
   - Applies/removes `.dark` class on `document.documentElement`
   - Detects system preference via `window.matchMedia("(prefers-color-scheme: dark)")`

2. **FOUC Prevention** (`src/frontend/index.html`):
   - Inline `<script>` in `<head>` runs before React loads
   - Synchronously applies `.dark` class based on saved preference
   - Prevents flash of light theme on page load
   - Uses same logic as `ThemeProvider` for consistency

3. **ThemeToggle Component** (`src/frontend/components/ThemeToggle.tsx`):
   - Cycles through: Light → Dark → System → Light
   - Uses `lucide-react` icons (Sun/Moon/Monitor)
   - Accessible button with screen reader labels

4. **Tailwind CSS 4 Configuration** (`src/frontend/styles/globals.css`):
   - Custom variant: `@custom-variant dark (&:is(.dark, .dark *));`
   - CSS variables for light/dark themes (`:root` and `.dark` selectors)
   - Use `dark:` prefix in components (e.g., `dark:bg-gray-900`)

#### Usage in Components

```typescript
// Access theme context
import { useTheme } from "@/components/ThemeProvider";
const { theme, setTheme } = useTheme();

// Apply dark mode styles with Tailwind
<div className="bg-white dark:bg-gray-900 text-black dark:text-white">
  Content
</div>
```

## Build System (scripts/build.ts)

Custom build script with:

- HTML entry point discovery via glob patterns
- Tailwind CSS integration via plugin
- CLI argument parsing for build customization
- Production optimizations (minify, sourcemap, etc.)

## Project Structure

```
src/
├── backend/
│   ├── index.tsx                  # Production entry point
│   ├── index.test-server.tsx      # Test entry point (uses FakeClaudeCodeService)
│   ├── server.ts                  # Bun.serve + routes + cert validation
│   ├── SessionManager.ts          # Manages multiple Claude sessions
│   ├── claudeRunner.ts            # XState machine for Claude process
│   ├── claudeRunner.test.ts       # Unit tests for state machine
│   ├── claudeRunner.integration.test.ts  # Integration tests with real CLI
│   └── services/
│       ├── index.ts                      # Service exports
│       ├── ClaudeCodeService.ts          # Interface definition
│       ├── RealClaudeCodeService.ts      # Production implementation
│       ├── FakeClaudeCodeService.ts      # Test mock implementation
│       └── FakeClaudeCodeService.test.ts # Mock unit tests
├── frontend/
│   ├── index.html             # HTML entry with React imports (includes FOUC script)
│   ├── frontend.tsx           # React root component (wraps with ThemeProvider)
│   ├── App.tsx                # Main application component (includes ThemeToggle)
│   ├── APITester.tsx          # Claude API testing UI
│   ├── chatMachine.ts         # Frontend state machine
│   ├── chatMachine.test.ts    # Frontend tests
│   ├── components/
│   │   ├── ThemeProvider.tsx  # Dark mode context provider
│   │   ├── ThemeToggle.tsx    # Theme switcher button
│   │   └── ui/                # shadcn/ui components
│   ├── lib/utils.ts           # Utility functions (cn, etc.)
│   ├── styles/globals.css     # Global styles with dark mode CSS variables
│   ├── assets/
│   │   ├── gen/               # Generated PWA icons (gitignored)
│   │   ├── icon.svg           # Source icon for generation
│   │   └── logo.svg           # App logo
│   ├── manifest.json          # PWA manifest
│   └── sw.js                  # Service worker

tests/
├── chat.spec.ts           # Playwright E2E tests (use FakeClaudeCodeService)
└── screenshots/           # Test screenshots (committed to git)
    ├── desktop-chat.png
    └── mobile-iphone6-chat.png

scripts/
├── build.ts                  # Production build script
├── generate-pwa-icons.js     # Icon generation from SVG (outputs to gen/)
└── generate-certs.sh         # mkcert wrapper for HTTPS certificates

docs/
├── bun.md                 # Bun guidelines (important reference)
└── architecture.md        # This file

certs/                     # Generated HTTPS certificates (gitignored)

playwright.config.ts       # Playwright configuration
bunfig.toml               # Bun configuration (test exclusions)
```

## TypeScript Configuration

- **Strict mode enabled** with additional safety checks
- **Module**: "Preserve" with bundler resolution
- **JSX**: react-jsx (React 19)
- **Path alias**: `@/*` → `./src/*`
- Allows `.ts` imports for bundler compatibility

## Testing

### Unit Tests

Use `bun test` with the built-in test runner:

- Test files should use `.test.ts` suffix (in `src/` directory)
- Import from `bun:test`: `import { test, expect, describe } from "bun:test"`
- 5-second timeout per test (configurable with `--timeout`)
- Supports snapshots with `--update-snapshots`
- **Integration Tests**: `claudeRunner.integration.test.ts` tests real Claude CLI (requires claude CLI installed)

```bash
bun test                  # Run all unit tests (src/ directory only)
bun test path/to/test.ts  # Run specific test file
```

### E2E Tests with Playwright

E2E tests are located in `tests/` directory and use Playwright for browser automation.

#### Configuration (playwright.config.ts)

- HTTPS support for self-signed dev certificates
- Automatic dev server startup with **FakeClaudeCodeService** (no real Claude CLI needed!)
- HTML reporter for test results
- Screenshots saved to `tests/screenshots/`
- Test files use `.spec.ts` suffix (Playwright-specific)

#### Writing UI Tests

1. **Test Structure**: Place tests in `tests/*.spec.ts` files
2. **Long Timeouts**: Use `test.setTimeout(120000)` for tests involving LLM responses
3. **Deterministic Prompts**: Use precise prompts to get predictable LLM responses
   ```typescript
   // Good: Precise, constrained prompt
   await input.fill('Please respond with exactly these three words: "Apple Banana Cherry"');

   // Bad: Open-ended prompt that may vary
   await input.fill('Tell me about fruits');
   ```

4. **Screenshots**: Capture screenshots for different viewports
   ```typescript
   // Mobile viewport (iPhone 6: 375x667)
   await page.setViewportSize({ width: 375, height: 667 });
   await page.screenshot({ path: 'tests/screenshots/mobile-feature.png' });

   // Desktop viewport
   await page.setViewportSize({ width: 1920, height: 1080 });
   await page.screenshot({ path: 'tests/screenshots/desktop-feature.png' });
   ```

5. **WebSocket Handling**: Wait for connection before interacting
   ```typescript
   await expect(page.getByText('Connected')).toBeVisible({ timeout: 10000 });
   ```

#### Screenshot Management

- Screenshots in `tests/screenshots/` ARE committed to git (for visual documentation)
- Test reports in `playwright-report/` are gitignored
- Use consistent naming: `[viewport]-[feature].png`

#### Verifying Changes

- After UI changes, run `bun run test:e2e` to regenerate screenshots
- Review screenshots visually to confirm layout improvements
- Use Playwright MCP tools during development for interactive testing

## PWA & Assets

### Generated Assets

All generated assets are located in gitignored directories and must be created during setup:

1. **PWA Icons** (`src/frontend/assets/gen/`):
   - Source: `src/frontend/assets/icon.svg`
   - Generated sizes: 180px (Apple touch), 192px, 512px
   - Command: `bun run generate:icons` (requires ImageMagick)
   - Output: `src/frontend/assets/gen/icon-{180,192,512}.png`

2. **HTTPS Certificates** (`certs/`):
   - Generated via mkcert (self-signed local CA)
   - Command: `bun run generate:certs` (requires mkcert)
   - Output: `certs/localhost+3.pem` and `certs/localhost+3-key.pem`
   - Server validates certificate existence on startup

### First-Time Setup

Run `bun run setup` to generate both certificates and icons in one command.

### Service Worker

- Handles offline caching and PWA installation
- Caches PWA icons via public URLs (`/icon-192.png`, `/icon-512.png`)
- Located at `src/frontend/sw.js`

## API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/*` | GET | Serves `index.html` (SPA fallback) |
| `/api/chat` | POST | Send messages to Claude CLI |
| `/api/models` | GET | Get available Claude models and default model |
| `/api/sessions` | GET | List all Claude sessions |
| `/api/sessions` | POST | Create a new Claude session |
| `/ws` | WebSocket | Real-time log streaming |
| `/manifest.json` | GET | PWA manifest |
| `/sw.js` | GET | Service worker |
